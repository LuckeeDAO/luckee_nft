# Luckee NFT 合约设计文档

## 1. 总体架构

### 1.1 合约结构
Luckee NFT 合约是一个基于 CosmWasm 的智能合约，实现了完整的 CW721 标准接口，并扩展了 Luckee 特有的功能。合约采用模块化设计，将不同功能分离到独立的模块中。

**核心模块：**
- `contract.rs` - 合约入口点和主调度逻辑
- `cw721.rs` - 标准 CW721 接口实现
- `luckee.rs` - Luckee 扩展功能（合成、铸造等）
- `admin.rs` - 管理员功能（暂停、紧急提取等）
- `events.rs` - 事件生成和属性管理
- `helpers.rs` - 通用辅助函数
- `recipes.rs` - 合成配方管理
- `state.rs` - 存储结构和状态管理
- `types.rs` - 核心数据类型定义
- `msg.rs` - 消息类型定义
- `error.rs` - 错误类型定义

### 1.2 核心功能
1. **标准 CW721 接口**：完整的 NFT 标准实现
2. **NFT 铸造与分发**：支持单个和批量铸造
3. **合成机制**：支持 NFT 升级合成（8层合成链）
4. **系列管理**：支持多系列 NFT 管理
5. **权限控制**：完善的访问控制和紧急机制
6. **事件系统**：统一的事件属性和索引支持

## 2. NFT 类型定义

### 2.1 九种主题 NFT
```rust
pub enum NftKind {
    Clover,          // 四叶草 - 未中奖，最基础的 NFT 类型
    Firefly,         // 流萤 - 末等奖，通过合成获得
    CrimsonKoi,      // 赤色锦鲤 - Tiny 规模头奖
    MagicalLamp,     // 三愿神灯 - Small 规模头奖
    FatesSpindle,    // 命运纺锤 - Medium 规模头奖
    Sage,            // 悟道者 - Large 规模头奖
    Polaris,         // 紫薇帝星 - Huge 规模头奖
    WheelOfDestiny,  // 轮盘之主 - 通过合成获得的高级 NFT
    Genesis,         // 造化元灵 - 通过合成获得的顶级 NFT
}
```

### 2.2 稀有度等级与兑换价值
```rust
impl NftKind {
    /// 获取 NFT 的稀有度等级（0-8，数字越大越稀有）
    pub fn rarity_level(&self) -> u8 {
        match self {
            NftKind::Clover => 0,           // 最普通
            NftKind::Firefly => 1,          // 普通
            NftKind::CrimsonKoi => 2,       // 稀有
            NftKind::MagicalLamp => 3,      // 史诗
            NftKind::FatesSpindle => 4,     // 传说
            NftKind::Sage => 5,             // 神话
            NftKind::Polaris => 6,          // 神圣
            NftKind::WheelOfDestiny => 7,   // 超越
            NftKind::Genesis => 8,          // 创世
        }
    }
    
    /// 获取 NFT 的兑换价值（以四叶草为基准单位）
    pub fn exchange_value(&self) -> u32 {
        match self {
            NftKind::Clover => 1,
            NftKind::Firefly => 2,          // 流萤 - 2个四叶草合成
            NftKind::CrimsonKoi => 4,       // 赤色锦鲤 - 4个四叶草合成
            NftKind::MagicalLamp => 20,     // 三愿神灯 - 20个四叶草合成
            NftKind::FatesSpindle => 200,   // 命运纺锤 - 200个四叶草合成
            NftKind::Sage => 2000,          // 悟道者 - 2000个四叶草合成
            NftKind::Polaris => 20000,      // 紫薇帝星 - 20000个四叶草合成
            NftKind::WheelOfDestiny => 200000, // 轮盘之主 - 200000个四叶草合成
            NftKind::Genesis => 2000000,    // 造化元灵 - 2000000个四叶草合成
        }
    }
}
```

### 2.3 规模等级
```rust
pub enum Scale {
    Tiny,        // 对应赤色锦鲤
    Small,       // 对应三愿神灯
    Medium,      // 对应命运纺锤
    Large,       // 对应悟道者
    Huge,        // 对应紫薇帝星
}

impl Scale {
    /// 获取规模对应的头奖 NFT 类型
    pub fn first_prize_nft(&self) -> NftKind {
        match self {
            Scale::Tiny => NftKind::CrimsonKoi,
            Scale::Small => NftKind::MagicalLamp,
            Scale::Medium => NftKind::FatesSpindle,
            Scale::Large => NftKind::Sage,
            Scale::Huge => NftKind::Polaris,
        }
    }
}
```

## 3. 数据结构

### 3.1 NFT 元数据扩展
```rust
pub struct NftMeta {
    pub kind: NftKind,                    // NFT 种类（包含稀有度信息）
    pub scale_origin: Scale,              // 来源规模
    pub physical_sku: Option<String>,     // 物理实物 SKU
    pub crafted_from: Option<Vec<u64>>,   // 合成来源 TokenId 列表
    pub series_id: String,                // 系列 ID
    pub collection_group_id: Option<String>, // 集合组 ID（用于合并）
    pub serial_in_series: u64,            // 系列内序号
}
```

### 3.2 合约配置结构
```rust
pub struct Config {
    pub name: String,                     // 合约名称
    pub symbol: String,                   // 合约符号
    pub minter: Addr,                     // 铸造者地址
    pub base_uri: Option<String>,         // 基础 URI（可选）
    pub owner: Addr,                      // 合约所有者地址
}
```

### 3.3 合成配方结构
```rust
pub struct Recipe {
    pub inputs: Vec<RecipeInput>,         // 输入 NFT 列表
    pub output: NftKind,                  // 输出的 NFT 类型
    pub cost: Option<cosmwasm_std::Coin>, // 合成费用（可选）
}

pub struct RecipeInput {
    pub nft_kind: NftKind,                // 需要的 NFT 类型
    pub count: u32,                       // 需要的数量
}
```

### 3.4 存储结构
```rust
// 核心存储项
pub const CONFIG: Item<Config> = Item::new("config");
pub const TOKEN_META: Map<u64, NftMeta> = Map::new("token_meta");
pub const SERIES_NEXT_SERIAL: Map<String, u64> = Map::new("series_next_serial");
pub const TOTAL_SUPPLY: Item<u64> = Item::new("total_supply");

// CW721 标准存储
pub const TOKEN_OWNERSHIP: Map<u64, Addr> = Map::new("token_owners");
pub const TOKEN_APPROVALS: Map<u64, Vec<Approval>> = Map::new("token_approvals");
pub const OPERATOR_APPROVALS: Map<(Addr, Addr), Expiration> = Map::new("operator_approvals");
pub const TOKENS_BY_OWNER: Map<Addr, Vec<u64>> = Map::new("tokens_by_owner");
pub const ALL_TOKENS: Map<u64, ()> = Map::new("all_tokens");

// 扩展存储项
pub const RECIPES: Map<String, Recipe> = Map::new("recipes");
pub const SYNTHESIS_HISTORY: Map<(Addr, u64), SynthesisRecord> = Map::new("synthesis_history");
pub const ALLOWED_MINTERS: Map<Addr, bool> = Map::new("allowed_minters");
pub const CONTRACT_PAUSED: Item<bool> = Item::new("contract_paused");
```

## 4. 核心流程

### 4.1 NFT 铸造流程
1. **权限验证**：检查调用者是否有铸造权限
2. **重复检查**：验证 token_id 是否已存在
3. **元数据保存**：保存 NFT 元数据到存储
4. **所有权设置**：设置 NFT 所有者
5. **索引更新**：更新所有者和全局索引
6. **供应量更新**：使用 `checked_add` 更新总供应量
7. **事件发出**：发出铸造事件

### 4.2 NFT 转移流程
1. **权限验证**：检查调用者是否有转移权限
2. **所有权验证**：验证当前所有者
3. **批准清理**：清理所有批准信息
4. **所有权更新**：更新 NFT 所有者
5. **索引维护**：更新所有者和全局索引
6. **事件发出**：发出转移事件

### 4.3 NFT 销毁流程
1. **权限验证**：检查调用者是否有销毁权限
2. **所有权验证**：验证当前所有者
3. **数据清理**：删除所有相关数据
4. **索引清理**：从所有索引中移除
5. **供应量更新**：使用 `checked_sub` 更新总供应量
6. **事件发出**：发出销毁事件

### 4.4 合成机制流程
1. **用户发起合成**：提交输入 NFT 列表和目标 NFT 类型
2. **权限验证**：检查用户对输入 NFT 的所有权
3. **配方验证**：检查是否满足合成条件
4. **输入销毁**：销毁所有输入 NFT
5. **输出铸造**：铸造目标 NFT
6. **历史记录**：记录合成操作历史
7. **事件发出**：发出合成事件

### 4.5 合成配方设计
```rust
// 默认合成配方（8层合成链）
// 第一层：2个四叶草 → 1个流萤
// 第二层：2个流萤 → 1个赤色锦鲤
// 第三层：5个赤色锦鲤 → 1个三愿神灯
// 第四层：10个三愿神灯 → 1个命运纺锤
// 第五层：10个命运纺锤 → 1个悟道者
// 第六层：10个悟道者 → 1个紫薇帝星
// 第七层：10个紫薇帝星 → 1个轮盘之主
// 第八层：10个轮盘之主 → 1个造化元灵
```

## 5. 接口设计

### 5.1 执行消息
```rust
pub enum ExecuteMsg {
    // ========== 标准 CW721 接口 ==========
    TransferNft { recipient: String, token_id: u64 },
    Approve { spender: String, token_id: u64, expires: Option<Expiration> },
    Revoke { spender: String, token_id: u64 },
    ApproveAll { operator: String, expires: Option<Expiration> },
    RevokeAll { operator: String },
    
    // ========== Luckee 扩展接口 ==========
    Mint { token_id: u64, owner: String, extension: NftMeta },
    Burn { token_id: u64 },
    
    // ========== 管理员接口 ==========
    UpdateMinter { new_minter: String },
    UpdateBaseUri { base_uri: String },
    
    // ========== 合成相关接口 ==========
    SetRecipe { target: NftKind, recipe: Recipe },
    RemoveRecipe { target: NftKind },
    Synthesize { inputs: Vec<u64>, target: NftKind },
    
    // ========== 批量操作接口 ==========
    BatchMint { mints: Vec<BatchMintItem> },
    SetMinter { minter: String, allowed: bool },
    
    // ========== 访问控制和紧急机制 ==========
    Pause {},
    Unpause {},
    EmergencyWithdraw { amount: Vec<cosmwasm_std::Coin> },
}
```

### 5.2 查询消息
```rust
pub enum QueryMsg {
    // ========== 标准 CW721 查询 ==========
    OwnerOf { token_id: u64, include_expired: Option<bool> },
    NftInfo { token_id: u64 },
    Approvals { token_id: u64, include_expired: Option<bool> },
    IsApprovedForAll { owner: String, operator: String },
    TokenUri { token_id: u64 },
    AllTokens { start_after: Option<u64>, limit: Option<u32> },
    Tokens { owner: String, start_after: Option<u64>, limit: Option<u32> },
    
    // ========== Luckee 扩展查询 ==========
    TokenMeta { token_id: u64 },
    TokensByKind { kind: NftKind, start_after: Option<u64>, limit: Option<u32> },
    TokensBySeries { series_id: String, start_after: Option<u64>, limit: Option<u32> },
    TokensByGroup { group_id: String, start_after: Option<u64>, limit: Option<u32> },
    LuckeeContractInfo {},
    
    // ========== 合成相关查询 ==========
    Recipe { target: NftKind },
    AllRecipes {},
    SynthesisPreview { inputs: Vec<u64>, target: NftKind },
    
    // ========== 标准 CW721 合约信息查询 ==========
    ContractInfo {},
}
```

## 6. 事件系统

### 6.1 事件属性常量
```rust
pub mod event_attributes {
    pub const ACTION: &str = "action";
    pub const TOKEN_ID: &str = "token_id";
    pub const OWNER: &str = "owner";
    pub const RECIPIENT: &str = "recipient";
    pub const FROM: &str = "from";
    pub const TO: &str = "to";
    pub const SPENDER: &str = "spender";
    pub const OPERATOR: &str = "operator";
    pub const KIND: &str = "kind";
    pub const SERIES_ID: &str = "series_id";
    pub const SERIAL: &str = "serial";
    pub const TOTAL_SUPPLY: &str = "total_supply";
    pub const INPUTS_COUNT: &str = "inputs_count";
    pub const OUTPUT_TOKEN_ID: &str = "output_token_id";
    pub const TARGET: &str = "target";
}

pub mod action_types {
    pub const MINT: &str = "mint";
    pub const BURN: &str = "burn";
    pub const TRANSFER: &str = "transfer";
    pub const APPROVE: &str = "approve";
    pub const REVOKE: &str = "revoke";
    pub const APPROVE_ALL: &str = "approve_all";
    pub const REVOKE_ALL: &str = "revoke_all";
    pub const SYNTHESIZE: &str = "synthesize";
    pub const BATCH_MINT: &str = "batch_mint";
}
```

### 6.2 标准事件
- **铸造事件**：记录 NFT 铸造操作
- **销毁事件**：记录 NFT 销毁操作
- **转移事件**：记录 NFT 所有权转移
- **批准事件**：记录 NFT 批准操作
- **撤销事件**：记录 NFT 批准撤销
- **合成事件**：记录 NFT 合成操作
- **批量铸造事件**：记录批量铸造操作

## 7. 安全机制

### 7.1 访问控制
- **铸造权限**：只有授权的铸造者可以铸造 NFT
- **所有权验证**：严格验证 NFT 所有权
- **管理员权限**：关键操作需要管理员权限
- **合约暂停**：支持紧急暂停机制

### 7.2 边界检查
- **溢出保护**：使用 `checked_add` 和 `checked_sub` 防止数值溢出
- **重复检查**：防止重复铸造相同 token_id
- **批量限制**：限制批量操作的大小
- **输入验证**：严格验证所有输入参数

### 7.3 状态一致性
- **批准清理**：转移和销毁时自动清理批准信息
- **索引维护**：确保所有索引的一致性
- **原子操作**：关键操作保证原子性

## 8. 测试覆盖

### 8.1 集成测试
- **核心功能测试**：19个测试用例，100%通过
- **安全测试**：3个测试用例，覆盖权限和边界检查
- **综合测试**：7个测试用例，覆盖复杂场景

### 8.2 测试场景
- **铸造测试**：正常铸造、重复铸造、权限验证
- **转移测试**：所有权转移、批准清理、索引维护
- **销毁测试**：NFT销毁、数据清理、供应量更新
- **合成测试**：合成操作、配方验证、历史记录
- **批量操作测试**：批量铸造、限制检查
- **查询测试**：分页查询、索引查询、元数据查询

## 9. 部署与配置

### 9.1 部署要求
- **CosmWasm 环境**：支持 CosmWasm 1.5+
- **存储要求**：足够的存储空间用于 NFT 数据
- **权限配置**：正确设置铸造者和管理员权限

### 9.2 初始配置
- **合约信息**：设置合约名称和符号
- **铸造者权限**：配置盲盒合约等铸造者
- **基础 URI**：设置 NFT 元数据的基础 URI
- **默认配方**：初始化默认合成配方

### 9.3 升级支持
- **版本管理**：支持合约版本升级
- **数据迁移**：保持数据兼容性
- **功能扩展**：支持新功能添加

## 10. 监控与运维

### 10.1 事件监控
- **标准事件**：监听所有标准 CW721 事件
- **扩展事件**：监听 Luckee 特有事件
- **错误事件**：监控异常和错误情况

### 10.2 性能指标
- **铸造统计**：NFT 铸造数量和频率
- **合成统计**：合成操作成功率
- **存储使用**：存储空间使用情况
- **Gas 消耗**：操作 Gas 消耗统计

### 10.3 运维工具
- **状态检查**：合约状态和配置检查
- **数据导出**：NFT 数据和历史记录导出
- **批量操作**：支持批量管理操作
- **紧急处理**：紧急情况下的快速响应

## 11. 未来扩展

### 11.1 功能扩展
- **新 NFT 类型**：支持更多 NFT 种类
- **复杂合成**：支持多输入复杂合成
- **跨链支持**：支持跨链 NFT 操作
- **实物绑定**：增强实物商品绑定功能

### 11.2 性能优化
- **存储优化**：优化存储结构和使用
- **查询优化**：提高查询性能和效率
- **批量优化**：优化批量操作性能
- **缓存机制**：引入缓存机制提高响应速度

### 11.3 集成扩展
- **盲盒集成**：与盲盒合约深度集成
- **市场集成**：与 NFT 市场平台集成
- **钱包集成**：与各种钱包应用集成
- **游戏集成**：与游戏应用集成

## 12. 总结

Luckee NFT 合约是一个功能完整、安全可靠的 NFT 合约实现，具有以下特点：

1. **标准兼容**：完全符合 CW721 标准
2. **功能丰富**：支持铸造、转移、销毁、合成等完整功能
3. **安全可靠**：完善的权限控制和边界检查
4. **易于扩展**：模块化设计便于功能扩展
5. **测试充分**：全面的测试覆盖确保质量
6. **事件完整**：统一的事件系统便于监控和集成

合约已经过充分测试和验证，可以安全部署到生产环境中使用。