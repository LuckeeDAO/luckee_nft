# Luckee NFT 合约接口文档

## 概述

本文档提供 Luckee NFT 合约的完整 API 接口说明，包括所有执行消息（ExecuteMsg）和查询消息（QueryMsg）的 JSON 示例。

## 合约地址

- **测试网**: `luckee1...` (待部署)
- **主网**: `luckee1...` (待部署)

## 执行消息 (ExecuteMsg)

### 标准 CW721 接口

#### 1. 转移 NFT 所有权

**消息**: `transfer_nft`

```json
{
  "transfer_nft": {
    "recipient": "luckee1abc123...",
    "token_id": 1
  }
}
```

**响应属性**:
- `action`: "transfer"
- `token_id`: "1"
- `from`: "luckee1def456..."
- `to`: "luckee1abc123..."

#### 2. 批准特定地址操作特定 NFT

**消息**: `approve`

```json
{
  "approve": {
    "spender": "luckee1marketplace...",
    "token_id": 1,
    "expires": {
      "at_time": "1700000000"
    }
  }
}
```

**响应属性**:
- `action`: "approve"
- `token_id`: "1"
- `owner`: "luckee1def456..."
- `spender`: "luckee1marketplace..."

#### 3. 撤销特定地址对特定 NFT 的批准

**消息**: `revoke`

```json
{
  "revoke": {
    "spender": "luckee1marketplace...",
    "token_id": 1
  }
}
```

**响应属性**:
- `action`: "revoke"
- `token_id`: "1"
- `owner`: "luckee1def456..."
- `spender`: "luckee1marketplace..."

#### 4. 批准操作员管理所有 NFT

**消息**: `approve_all`

```json
{
  "approve_all": {
    "operator": "luckee1marketplace...",
    "expires": {
      "at_height": 1000000
    }
  }
}
```

**响应属性**:
- `action`: "approve_all"
- `owner`: "luckee1def456..."
- `operator`: "luckee1marketplace..."

#### 5. 撤销操作员对所有 NFT 的管理权限

**消息**: `revoke_all`

```json
{
  "revoke_all": {
    "operator": "luckee1marketplace..."
  }
}
```

**响应属性**:
- `action`: "revoke_all"
- `owner`: "luckee1def456..."
- `operator`: "luckee1marketplace..."

### Luckee 扩展接口

#### 6. 铸造新的 NFT

**消息**: `mint`

```json
{
  "mint": {
    "token_id": 1,
    "owner": "luckee1user123...",
    "extension": {
      "kind": "Clover",
      "scale_origin": "Tiny",
      "physical_sku": null,
      "crafted_from": null,
      "series_id": "blind_box_001",
      "collection_group_id": null,
      "serial_in_series": 1
    }
  }
}
```

**响应属性**:
- `action`: "mint"
- `token_id`: "1"
- `owner`: "luckee1user123..."
- `kind`: "Clover"

#### 7. 销毁 NFT

**消息**: `burn`

```json
{
  "burn": {
    "token_id": 1
  }
}
```

**响应属性**:
- `action`: "burn"
- `token_id`: "1"
- `owner`: "luckee1user123..."

### 管理员接口

#### 8. 更新铸造者地址

**消息**: `update_minter`

```json
{
  "update_minter": {
    "new_minter": "luckee1newminter..."
  }
}
```

**响应属性**:
- `action`: "update_minter"
- `old_minter`: "luckee1oldminter..."
- `new_minter`: "luckee1newminter..."

#### 9. 更新基础 URI

**消息**: `update_base_uri`

```json
{
  "update_base_uri": {
    "base_uri": "https://new-metadata.luckee.io/"
  }
}
```

**响应属性**:
- `action`: "update_base_uri"
- `old_base_uri`: "https://luckee.io/metadata/"
- `new_base_uri`: "https://new-metadata.luckee.io/"

### 合成相关接口

#### 10. 设置合成配方

**消息**: `set_recipe`

```json
{
  "set_recipe": {
    "target": "Firefly",
    "recipe": {
      "inputs": [
        {
          "kind": "Clover",
          "amount": 2
        }
      ],
      "cost": {
        "denom": "uluckee",
        "amount": "1000"
      }
    }
  }
}
```

**响应属性**:
- `action`: "set_recipe"
- `target`: "Firefly"

#### 11. 删除合成配方

**消息**: `remove_recipe`

```json
{
  "remove_recipe": {
    "target": "Firefly"
  }
}
```

**响应属性**:
- `action`: "remove_recipe"
- `target`: "Firefly"

#### 12. 执行合成操作

**消息**: `synthesize`

```json
{
  "synthesize": {
    "inputs": [1, 2],
    "target": "Firefly"
  }
}
```

**响应属性**:
- `action`: "synthesize"
- `output_token_id`: "3"
- `target`: "Firefly"
- `inputs_count`: "2"

### 批量操作接口

#### 13. 批量铸造 NFT

**消息**: `batch_mint`

```json
{
  "batch_mint": {
    "mints": [
      {
        "token_id": 1,
        "owner": "luckee1user123...",
        "extension": {
          "kind": "Clover",
          "scale_origin": "Tiny",
          "physical_sku": null,
          "crafted_from": null,
          "series_id": "batch_001",
          "collection_group_id": null,
          "serial_in_series": 1
        }
      },
      {
        "token_id": 2,
        "owner": "luckee1user456...",
        "extension": {
          "kind": "Firefly",
          "scale_origin": "Small",
          "physical_sku": null,
          "crafted_from": null,
          "series_id": "batch_001",
          "collection_group_id": null,
          "serial_in_series": 2
        }
      }
    ]
  }
}
```

**响应属性**:
- `action`: "batch_mint"
- `count`: "2"

#### 14. 设置铸造者权限

**消息**: `set_minter`

```json
{
  "set_minter": {
    "minter": "luckee1newminter...",
    "allowed": true
  }
}
```

**响应属性**:
- `action`: "set_minter"
- `minter`: "luckee1newminter..."
- `allowed`: "true"

### 访问控制和紧急机制

#### 15. 暂停合约

**消息**: `pause`

```json
{
  "pause": {}
}
```

**响应属性**:
- `action`: "pause"

#### 16. 恢复合约

**消息**: `unpause`

```json
{
  "unpause": {}
}
```

**响应属性**:
- `action`: "unpause"

#### 17. 紧急提取资金

**消息**: `emergency_withdraw`

```json
{
  "emergency_withdraw": {
    "amount": [
      {
        "denom": "uluckee",
        "amount": "1000000"
      }
    ]
  }
}
```

**响应属性**:
- `action`: "emergency_withdraw"
- `amount`: "1000000uluckee"

## 查询消息 (QueryMsg)

### 标准 CW721 查询

#### 1. 查询 NFT 所有者信息

**查询**: `owner_of`

```json
{
  "owner_of": {
    "token_id": 1,
    "include_expired": false
  }
}
```

**响应**: `OwnerOfResponse`

```json
{
  "owner": "luckee1user123...",
  "approvals": [
    {
      "spender": "luckee1marketplace...",
      "expires": {
        "never": {}
      }
    }
  ]
}
```

#### 2. 查询 NFT 详细信息

**查询**: `nft_info`

```json
{
  "nft_info": {
    "token_id": 1
  }
}
```

**响应**: `NftInfoResponse<NftMeta>`

```json
{
  "token_uri": "https://luckee.io/metadata/1",
  "extension": {
    "kind": "Clover",
    "scale_origin": "Tiny",
    "physical_sku": null,
    "crafted_from": null,
    "series_id": "blind_box_001",
    "collection_group_id": null,
    "serial_in_series": 1
  }
}
```

#### 3. 查询 NFT 批准信息

**查询**: `approvals`

```json
{
  "approvals": {
    "token_id": 1,
    "include_expired": false
  }
}
```

**响应**: `ApprovalsResponse`

```json
{
  "approvals": [
    {
      "spender": "luckee1marketplace...",
      "expires": {
        "never": {}
      }
    }
  ]
}
```

#### 4. 查询操作员批准状态

**查询**: `is_approved_for_all`

```json
{
  "is_approved_for_all": {
    "owner": "luckee1user123...",
    "operator": "luckee1marketplace..."
  }
}
```

**响应**: `OperatorResponse`

```json
{
  "approval": {
    "spender": "luckee1marketplace...",
    "expires": {
      "at_height": 1000000
    }
  }
}
```

#### 5. 查询 NFT URI 信息

**查询**: `token_uri`

```json
{
  "token_uri": {
    "token_id": 1
  }
}
```

**响应**: `NftInfoResponse<NftMeta>`

```json
{
  "token_uri": "https://luckee.io/metadata/1",
  "extension": {
    "kind": "Clover",
    "scale_origin": "Tiny",
    "physical_sku": null,
    "crafted_from": null,
    "series_id": "blind_box_001",
    "collection_group_id": null,
    "serial_in_series": 1
  }
}
```

#### 6. 查询所有 NFT 列表

**查询**: `all_tokens`

```json
{
  "all_tokens": {
    "start_after": "10",
    "limit": 30
  }
}
```

**响应**: `TokensResponse`

```json
{
  "tokens": ["1", "2", "3", "4", "5"]
}
```

#### 7. 查询用户拥有的 NFT 列表

**查询**: `tokens`

```json
{
  "tokens": {
    "owner": "luckee1user123...",
    "start_after": "5",
    "limit": 30
  }
}
```

**响应**: `TokensResponse`

```json
{
  "tokens": ["1", "3", "7", "10"]
}
```

### Luckee 扩展查询

#### 8. 查询 NFT 扩展元数据

**查询**: `token_meta`

```json
{
  "token_meta": {
    "token_id": 1
  }
}
```

**响应**: `TokenMetaResponse`

```json
{
  "meta": {
    "kind": "Clover",
    "scale_origin": "Tiny",
    "physical_sku": null,
    "crafted_from": null,
    "series_id": "blind_box_001",
    "collection_group_id": null,
    "serial_in_series": 1
  }
}
```

#### 9. 按类型查询 NFT 列表

**查询**: `tokens_by_kind`

```json
{
  "tokens_by_kind": {
    "kind": "Clover",
    "start_after": "5",
    "limit": 30
  }
}
```

**响应**: `TokensByKindResponse`

```json
{
  "tokens": [1, 3, 7, 10, 15]
}
```

#### 10. 按系列查询 NFT 列表

**查询**: `tokens_by_series`

```json
{
  "tokens_by_series": {
    "series_id": "blind_box_001",
    "start_after": "5",
    "limit": 30
  }
}
```

**响应**: `TokensBySeriesResponse`

```json
{
  "tokens": [1, 2, 3, 4, 5]
}
```

#### 11. 按组查询 NFT 列表

**查询**: `tokens_by_group`

```json
{
  "tokens_by_group": {
    "group_id": "collection_001",
    "start_after": "5",
    "limit": 30
  }
}
```

**响应**: `TokensByGroupResponse`

```json
{
  "tokens": [1, 3, 7, 10, 15]
}
```

#### 12. 查询 Luckee 合约信息

**查询**: `luckee_contract_info`

```json
{
  "luckee_contract_info": {}
}
```

**响应**: `LuckeeContractInfoResponse`

```json
{
  "name": "Luckee NFT",
  "symbol": "LUCKEE",
  "minter": "luckee1minter...",
  "base_uri": "https://luckee.io/metadata/",
  "total_supply": 1000
}
```

### 合成相关查询

#### 13. 查询合成配方

**查询**: `recipe`

```json
{
  "recipe": {
    "target": "Firefly"
  }
}
```

**响应**: `RecipeResponse`

```json
{
  "recipe": {
    "inputs": [
      {
        "kind": "Clover",
        "amount": 2
      }
    ],
    "cost": {
      "denom": "uluckee",
      "amount": "1000"
    }
  }
}
```

#### 14. 查询所有合成配方

**查询**: `all_recipes`

```json
{
  "all_recipes": {
    "start_after": "Clover",
    "limit": 30
  }
}
```

**响应**: `AllRecipesResponse`

```json
{
  "recipes": [
    ["Firefly", {
      "inputs": [
        {
          "kind": "Clover",
          "amount": 2
        }
      ],
      "cost": {
        "denom": "uluckee",
        "amount": "1000"
      }
    }],
    ["CrimsonKoi", {
      "inputs": [
        {
          "kind": "Firefly",
          "amount": 2
        }
      ],
      "cost": {
        "denom": "uluckee",
        "amount": "5000"
      }
    }]
  ]
}
```

#### 15. 预览合成操作结果

**查询**: `synthesis_preview`

```json
{
  "synthesis_preview": {
    "inputs": [1, 2],
    "target": "Firefly"
  }
}
```

**响应**: `SynthesisPreviewResponse`

```json
{
  "can_synthesize": true,
  "required_inputs": [
    {
      "kind": "Clover",
      "amount": 2
    }
  ],
  "output_value": 2,
  "cost": {
    "denom": "uluckee",
    "amount": "1000"
  }
}
```

### CW721 集成查询

#### 16. 查询外部 CW721 合约地址

**查询**: `get_nft_contract`

```json
{
  "get_nft_contract": {}
}
```

**响应**: `NftContractResponse`

```json
{
  "contract_addr": null
}
```

#### 17. 查询标准 CW721 合约信息

**查询**: `contract_info`

```json
{
  "contract_info": {}
}
```

**响应**: `ContractInfoResponse`

```json
{
  "name": "Luckee NFT",
  "symbol": "LUCKEE"
}
```

## 错误响应

### 常见错误码

#### 1. TokenAlreadyExists

**错误信息**: "Token already exists"

**触发场景**: 
- 尝试铸造已存在的 token_id
- 批量铸造时存在重复的 token_id

**示例**:
```json
{
  "error": "Token already exists"
}
```

#### 2. MinterNotAuthorized

**错误信息**: "Minter not authorized"

**触发场景**:
- 非授权地址尝试铸造 NFT
- 未在 ALLOWED_MINTERS 列表中的地址尝试铸造

**示例**:
```json
{
  "error": "Minter not authorized"
}
```

#### 3. TokenNotFound

**错误信息**: "Token not found"

**触发场景**:
- 查询不存在的 NFT
- 尝试操作不存在的 NFT

**示例**:
```json
{
  "error": "Token not found"
}
```

#### 4. NotOwned

**错误信息**: "Token not owned by sender"

**触发场景**:
- 非所有者尝试转移 NFT
- 非所有者尝试销毁 NFT
- 非所有者尝试设置批准

**示例**:
```json
{
  "error": "Token not owned by sender"
}
```

#### 5. Unauthorized

**错误信息**: "Unauthorized"

**触发场景**:
- 非管理员尝试执行管理员操作
- 非所有者尝试执行所有者操作

**示例**:
```json
{
  "error": "Unauthorized"
}
```

#### 6. ContractPaused

**错误信息**: "Contract is paused"

**触发场景**:
- 合约暂停状态下尝试执行操作

**示例**:
```json
{
  "error": "Contract is paused"
}
```

#### 7. RecipeNotFound

**错误信息**: "Recipe not found"

**触发场景**:
- 尝试合成不存在的配方
- 查询不存在的合成配方

**示例**:
```json
{
  "error": "Recipe not found"
}
```

#### 8. TooManyInputs

**错误信息**: "Too many inputs for synthesis: {count}"

**触发场景**:
- 合成操作输入 NFT 数量超过 MAX_SYNTHESIS_INPUTS (50)

**示例**:
```json
{
  "error": "Too many inputs for synthesis: 51"
}
```

#### 9. TooManyTokens

**错误信息**: "Too many tokens in combination: {count}"

**触发场景**:
- 批量铸造数量超过 MAX_BATCH_MINT (100)

**示例**:
```json
{
  "error": "Too many tokens in combination: 101"
}
```

#### 10. Overflow

**错误信息**: "Overflow error"

**触发场景**:
- 数值运算溢出
- 总供应量计算溢出

**示例**:
```json
{
  "error": "Overflow error"
}
```

## NFT 类型定义

### NftKind 枚举

```rust
pub enum NftKind {
    Clover,        // 四叶草 - 兑换价值: 1
    Firefly,       // 流萤 - 兑换价值: 2
    CrimsonKoi,    // 赤色锦鲤 - 兑换价值: 4
    MagicalLamp,   // 三愿神灯 - 兑换价值: 20
    FatesSpindle,  // 命运纺锤 - 兑换价值: 200
    Sage,          // 悟道者 - 兑换价值: 2000
    Polaris,       // 紫薇帝星 - 兑换价值: 20000
    WheelOfDestiny, // 轮盘之主 - 兑换价值: 200000
    Genesis,       // 造化元灵 - 兑换价值: 2000000
}
```

### Scale 枚举

```rust
pub enum Scale {
    Tiny,   // 小规模
    Small,  // 中小规模
    Medium, // 中等规模
    Large,  // 大规模
    Huge,   // 超大规模
}
```

## 使用示例

### 完整的铸造流程

1. **设置合成配方** (管理员操作)
```json
{
  "set_recipe": {
    "target": "Firefly",
    "recipe": {
      "inputs": [
        {
          "kind": "Clover",
          "amount": 2
        }
      ],
      "cost": {
        "denom": "uluckee",
        "amount": "1000"
      }
    }
  }
}
```

2. **铸造基础 NFT** (授权铸造者操作)
```json
{
  "mint": {
    "token_id": 1,
    "owner": "luckee1user123...",
    "extension": {
      "kind": "Clover",
      "scale_origin": "Tiny",
      "physical_sku": null,
      "crafted_from": null,
      "series_id": "blind_box_001",
      "collection_group_id": null,
      "serial_in_series": 1
    }
  }
}
```

3. **预览合成结果** (用户查询)
```json
{
  "synthesis_preview": {
    "inputs": [1, 2],
    "target": "Firefly"
  }
}
```

4. **执行合成操作** (用户操作)
```json
{
  "synthesize": {
    "inputs": [1, 2],
    "target": "Firefly"
  }
}
```

## 注意事项

1. **权限控制**: 只有授权的铸造者可以铸造 NFT
2. **所有权验证**: 只有 NFT 所有者可以转移、销毁或设置批准
3. **管理员权限**: 只有合约所有者可以执行管理员操作
4. **合成限制**: 合成操作有输入数量限制 (MAX_SYNTHESIS_INPUTS = 50)
5. **批量限制**: 批量铸造有数量限制 (MAX_BATCH_MINT = 100)
6. **暂停机制**: 合约暂停时，大部分操作将被阻止
7. **事件记录**: 所有操作都会产生相应的事件记录

## 版本信息

- **合约版本**: 0.1.0
- **CosmWasm 版本**: 2.2.2
- **文档版本**: 1.0.0
- **最后更新**: 2024年12月
