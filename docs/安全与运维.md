# Luckee NFT 合约安全与运维指南

## 概述

本文档详细说明 Luckee NFT 合约的安全机制、权限控制、运维流程和审计要求，确保合约在生产环境中的安全稳定运行。

## 安全架构

### 1. 权限控制体系

#### 1.1 角色定义

**合约所有者 (Owner)**:
- 权限: 最高权限，可执行所有管理员操作
- 操作: 更新配置、设置配方、暂停合约、紧急提取
- 安全要求: 必须使用多签钱包或时间锁合约

**授权铸造者 (Authorized Minters)**:
- 权限: 铸造 NFT 的权限
- 操作: 单个铸造、批量铸造
- 安全要求: 最小权限原则，定期审计

**普通用户 (Users)**:
- 权限: 标准 CW721 操作
- 操作: 转移、批准、销毁自己的 NFT
- 安全要求: 无特殊要求

#### 1.2 权限验证机制

```rust
// 所有者权限验证
pub fn verify_owner_permission(deps: Deps, sender: &Addr) -> Result<(), ContractError> {
    let config = CONFIG.load(deps.storage)?;
    if config.owner != *sender {
        return Err(ContractError::Unauthorized {});
    }
    Ok(())
}

// 铸造者权限验证
pub fn verify_minter_permission(deps: Deps, sender: &Addr, config: &Config) -> Result<(), ContractError> {
    if !is_authorized_minter(deps, sender, config)? {
        return Err(ContractError::MinterNotAuthorized {});
    }
    Ok(())
}
```

### 2. 访问控制

#### 2.1 合约暂停机制

**暂停功能**:
- 触发条件: 所有者调用 `pause`
- 影响范围: 除 `unpause` 和 `emergency_withdraw` 外的所有操作
- 恢复条件: 所有者调用 `unpause`

**实现示例**:
```rust
pub fn execute_pause(deps: DepsMut, info: MessageInfo) -> Result<Response, ContractError> {
    verify_owner_permission(deps.as_ref(), &info.sender)?;
    
    CONTRACT_PAUSED.save(deps.storage, &true)?;
    
    Ok(Response::new()
        .add_attribute("action", "pause")
        .add_attribute("paused_by", info.sender.to_string()))
}
```

#### 2.2 紧急提取机制

**EmergencyWithdraw 权限**:
- 仅合约所有者可调用
- 建议强制使用多签钱包作为所有者
- 建议设置时间锁延迟

**安全实现**:
```rust
pub fn execute_emergency_withdraw(
    deps: DepsMut,
    info: MessageInfo,
    amount: Vec<Coin>,
) -> Result<Response, ContractError> {
    verify_owner_permission(deps.as_ref(), &info.sender)?;
    
    // 验证提取金额
    for coin in &amount {
        if coin.amount.is_zero() {
            return Err(ContractError::InvalidAmount {});
        }
    }
    
    // 执行提取
    let mut response = Response::new()
        .add_attribute("action", "emergency_withdraw")
        .add_attribute("amount", format!("{:?}", amount));
    
    for coin in amount {
        response = response.add_message(BankMsg::Send {
            to_address: info.sender.to_string(),
            amount: vec![coin],
        });
    }
    
    Ok(response)
}
```

### 3. 铸造者管理

#### 3.1 最小权限原则

**ALLOWED_MINTERS 管理**:
- 定期审查授权列表
- 移除不必要的授权
- 记录所有变更操作

**实现示例**:
```rust
pub fn execute_set_minter(
    deps: DepsMut,
    info: MessageInfo,
    minter: String,
    allowed: bool,
) -> Result<Response, ContractError> {
    verify_owner_permission(deps.as_ref(), &info.sender)?;
    
    let minter_addr = deps.api.addr_validate(&minter)?;
    ALLOWED_MINTERS.save(deps.storage, minter_addr.clone(), &allowed)?;
    
    // 记录操作日志
    let log_entry = MinterChangeLog {
        timestamp: env.block.time.seconds(),
        changed_by: info.sender.clone(),
        minter: minter_addr.clone(),
        allowed,
    };
    MINTER_CHANGE_LOG.save(deps.storage, (info.sender.clone(), env.block.time.seconds()), &log_entry)?;
    
    Ok(Response::new()
        .add_attribute("action", "set_minter")
        .add_attribute("minter", minter)
        .add_attribute("allowed", allowed.to_string())
        .add_attribute("changed_by", info.sender.to_string()))
}
```

#### 3.2 操作审计

**审计日志结构**:
```rust
#[derive(Serialize, Deserialize, Clone, Debug, PartialEq)]
pub struct MinterChangeLog {
    pub timestamp: u64,
    pub changed_by: Addr,
    pub minter: Addr,
    pub allowed: bool,
}
```

**查询审计日志**:
```rust
pub fn query_minter_change_log(
    deps: Deps,
    start_after: Option<(Addr, u64)>,
    limit: Option<u32>,
) -> StdResult<Binary> {
    let limit = limit.unwrap_or(30).min(100) as usize;
    
    let logs: Vec<MinterChangeLog> = MINTER_CHANGE_LOG
        .range(deps.storage, start_after.map(|(addr, time)| Bound::exclusive((addr, time))), None, Order::Ascending)
        .take(limit)
        .collect::<Result<Vec<_>, _>>()?
        .into_iter()
        .map(|(_, log)| log)
        .collect();
    
    to_json_binary(&MinterChangeLogResponse { logs })
}
```

## 运维流程

### 1. 日常运维

#### 1.1 监控指标

**关键指标**:
- 合约调用频率
- Gas 消耗趋势
- 错误率统计
- 铸造数量监控
- 合成操作统计

**监控脚本示例**:
```bash
#!/bin/bash
# 监控脚本

CONTRACT_ADDRESS="luckee1..."
NODE="https://rpc.luckee-testnet.com:443"

# 查询合约状态
echo "=== 合约状态 ==="
wasmd query wasm contract $CONTRACT_ADDRESS --node $NODE

# 查询总供应量
echo "=== 总供应量 ==="
TOTAL_SUPPLY=$(wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"contract_info": {}}' --node $NODE | jq -r '.data.total_supply')
echo "Total Supply: $TOTAL_SUPPLY"

# 查询最近事件
echo "=== 最近事件 ==="
wasmd query txs --events "wasm._contract_address='$CONTRACT_ADDRESS'" --limit 10 --node $NODE
```

#### 1.2 健康检查

**健康检查脚本**:
```bash
#!/bin/bash
# 健康检查脚本

CONTRACT_ADDRESS="luckee1..."
NODE="https://rpc.luckee-testnet.com:443"

# 检查合约是否可访问
echo "检查合约可访问性..."
wasmd query wasm contract $CONTRACT_ADDRESS --node $NODE > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✅ 合约可访问"
else
    echo "❌ 合约不可访问"
    exit 1
fi

# 检查合约是否暂停
echo "检查合约状态..."
PAUSED=$(wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"contract_info": {}}' --node $NODE | jq -r '.data.paused // false')
if [ "$PAUSED" = "false" ]; then
    echo "✅ 合约正常运行"
else
    echo "⚠️ 合约已暂停"
fi

# 检查铸造者权限
echo "检查铸造者权限..."
MINTERS=$(wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"all_minters": {}}' --node $NODE | jq -r '.data.minters')
echo "授权铸造者: $MINTERS"
```

### 2. 应急响应

#### 2.1 应急响应流程

**1. 问题识别**:
- 监控告警
- 用户反馈
- 社区报告

**2. 问题评估**:
- 影响范围评估
- 严重程度评估
- 紧急程度评估

**3. 应急措施**:
- 暂停合约 (如必要)
- 通知相关方
- 启动调查

**4. 问题解决**:
- 根因分析
- 修复实施
- 验证测试

**5. 恢复操作**:
- 恢复服务
- 监控验证
- 事后总结

#### 2.2 应急操作脚本

**紧急暂停脚本**:
```bash
#!/bin/bash
# 紧急暂停脚本

CONTRACT_ADDRESS="luckee1..."
ADMIN_ADDRESS="luckee1..."
CHAIN_ID="luckee-testnet"
NODE="https://rpc.luckee-testnet.com:443"

echo "⚠️ 执行紧急暂停操作..."
echo "合约地址: $CONTRACT_ADDRESS"
echo "管理员: $ADMIN_ADDRESS"

# 确认操作
read -p "确认执行暂停操作? (yes/no): " confirm
if [ "$confirm" != "yes" ]; then
    echo "操作已取消"
    exit 1
fi

# 执行暂停
PAUSE_MSG='{"pause": {}}'
wasmd tx wasm execute $CONTRACT_ADDRESS "$PAUSE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas auto \
  --yes

echo "✅ 暂停操作已执行"
```

**紧急恢复脚本**:
```bash
#!/bin/bash
# 紧急恢复脚本

CONTRACT_ADDRESS="luckee1..."
ADMIN_ADDRESS="luckee1..."
CHAIN_ID="luckee-testnet"
NODE="https://rpc.luckee-testnet.com:443"

echo "🔄 执行恢复操作..."
echo "合约地址: $CONTRACT_ADDRESS"
echo "管理员: $ADMIN_ADDRESS"

# 确认操作
read -p "确认执行恢复操作? (yes/no): " confirm
if [ "$confirm" != "yes" ]; then
    echo "操作已取消"
    exit 1
fi

# 执行恢复
UNPAUSE_MSG='{"unpause": {}}'
wasmd tx wasm execute $CONTRACT_ADDRESS "$UNPAUSE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas auto \
  --yes

echo "✅ 恢复操作已执行"
```

### 3. 升级管理

#### 3.1 升级流程

**1. 升级准备**:
- 代码审查
- 测试验证
- 升级计划

**2. 升级执行**:
- 上传新版本
- 执行迁移
- 验证功能

**3. 升级后验证**:
- 功能测试
- 性能监控
- 用户反馈

#### 3.2 升级脚本

**合约升级脚本**:
```bash
#!/bin/bash
# 合约升级脚本

OLD_CONTRACT_ADDRESS="luckee1..."
NEW_WASM_FILE="target/wasm32-unknown-unknown/release/luckee_nft_v2_optimized.wasm"
ADMIN_ADDRESS="luckee1..."
CHAIN_ID="luckee-testnet"
NODE="https://rpc.luckee-testnet.com:443"

echo "🔄 开始合约升级..."
echo "旧合约地址: $OLD_CONTRACT_ADDRESS"
echo "新WASM文件: $NEW_WASM_FILE"

# 检查文件存在
if [ ! -f "$NEW_WASM_FILE" ]; then
    echo "❌ WASM文件不存在: $NEW_WASM_FILE"
    exit 1
fi

# 上传新版本
echo "📤 上传新版本合约..."
UPLOAD_RESULT=$(wasmd tx wasm store "$NEW_WASM_FILE" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas auto \
  --yes \
  --output json)

NEW_CODE_ID=$(echo "$UPLOAD_RESULT" | jq -r '.logs[0].events[] | select(.type=="store_code") | .attributes[] | select(.key=="code_id") | .value')
echo "新Code ID: $NEW_CODE_ID"

# 执行迁移
echo "🔄 执行合约迁移..."
MIGRATE_MSG='{"migrate": {}}'
wasmd tx wasm migrate $OLD_CONTRACT_ADDRESS $NEW_CODE_ID "$MIGRATE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas auto \
  --yes

echo "✅ 合约升级完成"
echo "新Code ID: $NEW_CODE_ID"
```

## 审计要求

### 1. 操作审计

#### 1.1 重要操作审计

**需要审计的操作**:
- `set_recipe` - 设置合成配方
- `remove_recipe` - 删除合成配方
- `set_minter` - 设置铸造者权限
- `pause` - 暂停合约
- `unpause` - 恢复合约
- `emergency_withdraw` - 紧急提取

**审计日志结构**:
```rust
#[derive(Serialize, Deserialize, Clone, Debug, PartialEq)]
pub struct AuditLog {
    pub timestamp: u64,
    pub operator: Addr,
    pub action: String,
    pub details: String,
    pub tx_hash: Option<String>,
}
```

#### 1.2 审计查询接口

**查询审计日志**:
```rust
pub fn query_audit_logs(
    deps: Deps,
    start_after: Option<(u64, String)>,
    limit: Option<u32>,
) -> StdResult<Binary> {
    let limit = limit.unwrap_or(30).min(100) as usize;
    
    let logs: Vec<AuditLog> = AUDIT_LOGS
        .range(deps.storage, start_after.map(|(time, action)| Bound::exclusive((time, action))), None, Order::Descending)
        .take(limit)
        .collect::<Result<Vec<_>, _>>()?
        .into_iter()
        .map(|(_, log)| log)
        .collect();
    
    to_json_binary(&AuditLogResponse { logs })
}
```

### 2. 离线审核流程

#### 2.1 审核要求

**审核内容**:
- 操作合理性
- 权限验证
- 参数正确性
- 影响评估

**审核流程**:
1. 操作申请
2. 技术审核
3. 业务审核
4. 安全审核
5. 执行批准

#### 2.2 审核工具

**审核检查清单**:
```markdown
# 操作审核检查清单

## 基本信息
- [ ] 操作类型: ___________
- [ ] 操作人员: ___________
- [ ] 操作时间: ___________
- [ ] 操作原因: ___________

## 技术审核
- [ ] 参数格式正确
- [ ] 权限验证通过
- [ ] 业务逻辑合理
- [ ] 影响范围可控

## 安全审核
- [ ] 无安全风险
- [ ] 符合安全策略
- [ ] 审计日志完整
- [ ] 回滚方案可行

## 业务审核
- [ ] 符合业务需求
- [ ] 用户体验良好
- [ ] 成本效益合理
- [ ] 风险可控

## 批准
- [ ] 技术负责人: ___________
- [ ] 安全负责人: ___________
- [ ] 业务负责人: ___________
- [ ] 最终批准: ___________
```

### 3. 合规要求

#### 3.1 数据保护

**隐私保护**:
- 不存储用户敏感信息
- 最小化数据收集
- 数据加密存储
- 访问权限控制

**数据保留**:
- 审计日志保留 7 年
- 操作记录永久保留
- 定期备份数据
- 安全删除过期数据

#### 3.2 监管合规

**合规要求**:
- 遵守当地法律法规
- 满足监管机构要求
- 定期合规检查
- 及时报告异常

**合规检查**:
```bash
#!/bin/bash
# 合规检查脚本

CONTRACT_ADDRESS="luckee1..."
NODE="https://rpc.luckee-testnet.com:443"

echo "=== 合规检查报告 ==="
echo "检查时间: $(date)"
echo "合约地址: $CONTRACT_ADDRESS"

# 检查合约状态
echo "1. 合约状态检查"
wasmd query wasm contract $CONTRACT_ADDRESS --node $NODE

# 检查权限配置
echo "2. 权限配置检查"
wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"contract_info": {}}' --node $NODE

# 检查铸造者权限
echo "3. 铸造者权限检查"
wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"all_minters": {}}' --node $NODE

# 检查合成配方
echo "4. 合成配方检查"
wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"all_recipes": {}}' --node $NODE

echo "=== 检查完成 ==="
```

## 安全最佳实践

### 1. 密钥管理

#### 1.1 密钥安全

**密钥保护**:
- 使用硬件钱包
- 多重签名验证
- 定期密钥轮换
- 安全备份存储

**密钥管理策略**:
```bash
# 密钥管理脚本
#!/bin/bash

# 创建新密钥
create_new_key() {
    local key_name=$1
    wasmd keys add $key_name --keyring-backend file
    echo "新密钥已创建: $key_name"
}

# 备份密钥
backup_key() {
    local key_name=$1
    wasmd keys export $key_name --keyring-backend file --unarmored-hex > "${key_name}_backup.hex"
    echo "密钥已备份: ${key_name}_backup.hex"
}

# 轮换密钥
rotate_key() {
    local old_key=$1
    local new_key=$2
    
    echo "开始密钥轮换..."
    create_new_key $new_key
    backup_key $old_key
    echo "密钥轮换完成"
}
```

#### 1.2 多签配置

**多签钱包设置**:
```bash
# 创建多签钱包
wasmd keys add multisig-wallet --multisig-threshold 3 --multisig key1,key2,key3

# 查看多签信息
wasmd keys show multisig-wallet --multisig-threshold 3
```

### 2. 监控告警

#### 2.1 告警配置

**关键告警**:
- 合约暂停/恢复
- 大量铸造操作
- 异常合成操作
- 权限变更操作
- 紧急提取操作

**告警脚本**:
```bash
#!/bin/bash
# 告警脚本

CONTRACT_ADDRESS="luckee1..."
NODE="https://rpc.luckee-testnet.com:443"
WEBHOOK_URL="https://hooks.slack.com/services/..."

# 发送告警
send_alert() {
    local message=$1
    curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"🚨 Luckee NFT 告警: $message\"}" \
        $WEBHOOK_URL
}

# 检查合约状态
check_contract_status() {
    local paused=$(wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"contract_info": {}}' --node $NODE | jq -r '.data.paused // false')
    if [ "$paused" = "true" ]; then
        send_alert "合约已暂停"
    fi
}

# 检查异常操作
check_anomalous_operations() {
    # 检查最近1小时的铸造操作
    local mint_count=$(wasmd query txs --events "wasm._contract_address='$CONTRACT_ADDRESS'&wasm.action='mint'" --limit 100 --node $NODE | jq '.txs | length')
    if [ "$mint_count" -gt 50 ]; then
        send_alert "检测到大量铸造操作: $mint_count 次"
    fi
}

# 执行检查
check_contract_status
check_anomalous_operations
```

### 3. 应急准备

#### 3.1 应急计划

**应急响应团队**:
- 技术负责人
- 安全负责人
- 业务负责人
- 客服负责人

**应急联系方式**:
- 技术团队: tech@luckee.io
- 安全团队: security@luckee.io
- 业务团队: business@luckee.io

#### 3.2 应急工具

**应急工具包**:
```bash
#!/bin/bash
# 应急工具包

# 环境配置
CONTRACT_ADDRESS="luckee1..."
ADMIN_ADDRESS="luckee1..."
CHAIN_ID="luckee-testnet"
NODE="https://rpc.luckee-testnet.com:443"

# 快速暂停
quick_pause() {
    echo "执行快速暂停..."
    wasmd tx wasm execute $CONTRACT_ADDRESS '{"pause": {}}' \
      --from $ADMIN_ADDRESS \
      --chain-id $CHAIN_ID \
      --node $NODE \
      --gas auto \
      --yes
}

# 快速恢复
quick_unpause() {
    echo "执行快速恢复..."
    wasmd tx wasm execute $CONTRACT_ADDRESS '{"unpause": {}}' \
      --from $ADMIN_ADDRESS \
      --chain-id $CHAIN_ID \
      --node $NODE \
      --gas auto \
      --yes
}

# 状态检查
status_check() {
    echo "合约状态检查..."
    wasmd query wasm contract $CONTRACT_ADDRESS --node $NODE
}

# 显示菜单
show_menu() {
    echo "=== 应急工具包 ==="
    echo "1. 快速暂停"
    echo "2. 快速恢复"
    echo "3. 状态检查"
    echo "4. 退出"
    echo "请选择操作: "
}

# 主循环
while true; do
    show_menu
    read choice
    case $choice in
        1) quick_pause ;;
        2) quick_unpause ;;
        3) status_check ;;
        4) exit 0 ;;
        *) echo "无效选择" ;;
    esac
done
```

## 总结

本安全与运维指南提供了 Luckee NFT 合约的完整安全管理框架，包括：

1. **权限控制**: 明确的角色定义和权限验证机制
2. **访问控制**: 合约暂停机制和紧急提取功能
3. **运维流程**: 日常监控、应急响应和升级管理
4. **审计要求**: 操作审计、离线审核和合规检查
5. **安全实践**: 密钥管理、监控告警和应急准备

通过遵循本指南，可以确保 Luckee NFT 合约在生产环境中的安全稳定运行，同时满足合规和审计要求。

---

**文档版本**: 1.0.0  
**最后更新**: 2024年12月  
**维护团队**: Luckee DAO 安全团队
