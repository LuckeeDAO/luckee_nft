# Luckee NFT 合约部署指南

## 概述

本文档提供 Luckee NFT 合约的完整部署指南，包括环境配置、构建流程、部署步骤、回滚操作和迁移说明。

## 部署前准备

### 1. 系统要求

**最低系统要求**:
- Ubuntu 20.04+ / CentOS 8+ / macOS 10.15+
- 4GB RAM
- 10GB 可用磁盘空间
- 稳定的网络连接

**推荐系统配置**:
- Ubuntu 22.04 LTS
- 8GB RAM
- 20GB 可用磁盘空间
- 高速网络连接

### 2. 必需软件安装

#### 2.1 Rust 工具链

```bash
# 安装 Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.cargo/env

# 添加 wasm32 目标
rustup target add wasm32-unknown-unknown

# 验证安装
rustc --version
cargo --version
```

#### 2.2 CosmWasm 工具链

```bash
# 安装 wasmd
wget https://github.com/CosmWasm/wasmd/releases/download/v0.45.0/wasmd-0.45.0-linux-amd64
chmod +x wasmd-0.45.0-linux-amd64
sudo mv wasmd-0.45.0-linux-amd64 /usr/local/bin/wasmd

# 验证安装
wasmd version
```

#### 2.3 wasm-opt 优化工具

```bash
# 安装 wasm-opt (推荐使用 Docker)
docker pull cosmwasm/workspace-optimizer

# 或者从源码编译
# 需要安装 binaryen
sudo apt-get update
sudo apt-get install binaryen
```

#### 2.4 其他依赖

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y build-essential git jq curl

# CentOS/RHEL
sudo yum groupinstall -y "Development Tools"
sudo yum install -y git jq curl

# macOS
brew install git jq curl
```

## 环境配置

### 1. 必需环境变量

创建环境配置文件 `.env`:

```bash
# 管理员配置
export ADMIN_ADDRESS="luckee1admin..."              # 管理员地址 (必需)
export ADMIN_KEY_NAME="admin"                       # 管理员密钥名称

# 铸造者配置
export MINTER_ADDRESS="luckee1minter..."            # 铸造者地址 (必需)

# 链配置
export CHAIN_ID="luckee-testnet"                    # 链ID (必需)
export NODE="https://rpc.luckee-testnet.com:443"    # RPC节点地址 (必需)
export GAS_PRICES="0.025uluckee"                    # Gas价格 (必需)
export GAS_ADJUSTMENT="1.5"                         # Gas调整系数

# 部署配置
export CONTRACT_NAME="luckee_nft"                   # 合约名称
export CONTRACT_VERSION="0.1.0"                     # 合约版本
export BASE_URI="https://luckee.io/metadata/"       # 基础URI

# 密钥环配置
export KEYRING_BACKEND="test"                       # 密钥环后端 (test/file/os)
export KEYRING_PASSWORD="your_password"             # 密钥环密码
```

### 2. 密钥管理

#### 2.1 创建密钥

```bash
# 创建管理员密钥
wasmd keys add $ADMIN_KEY_NAME --keyring-backend $KEYRING_BACKEND

# 查看密钥地址
wasmd keys show $ADMIN_KEY_NAME --keyring-backend $KEYRING_BACKEND

# 导出密钥 (备份用)
wasmd keys export $ADMIN_KEY_NAME --keyring-backend $KEYRING_BACKEND --unarmored-hex > admin_key.hex
```

#### 2.2 获取测试代币

```bash
# 从测试网水龙头获取代币
curl -X POST "https://faucet.luckee-testnet.com/claim" \
  -H "Content-Type: application/json" \
  -d '{"address": "'$ADMIN_ADDRESS'"}'
```

### 3. 验证环境

```bash
# 验证链连接
wasmd query bank balances $ADMIN_ADDRESS --node $NODE

# 验证账户余额
wasmd query account $ADMIN_ADDRESS --node $NODE
```

## 构建流程

### 1. 源码构建

```bash
# 克隆项目
git clone https://github.com/luckee-dao/luckee_nft.git
cd luckee_nft

# 检查编译
cargo check

# 运行测试
cargo test

# 构建 release 版本
RUSTFLAGS='-C link-arg=-s' cargo build --release --target wasm32-unknown-unknown
```

### 2. no_std 构建 (推荐)

```bash
# 构建 no_std 版本
cargo build --release --target wasm32-unknown-unknown --no-default-features --features cosmwasm

# 验证构建结果
ls -la target/wasm32-unknown-unknown/release/luckee_nft.wasm
```

### 3. WASM 优化

#### 3.1 使用 wasm-opt 优化

```bash
# 本地优化
wasm-opt -Os target/wasm32-unknown-unknown/release/luckee_nft.wasm \
  -o target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm

# 验证优化结果
ls -la target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm
```

#### 3.2 使用 Docker 优化 (推荐)

```bash
# 创建优化脚本
cat > optimize.sh << 'EOF'
#!/bin/bash
docker run --rm -v "$(pwd)":/code \
  --mount type=volume,source="$(basename "$(pwd)")_cache",target=/code/target \
  --mount type=volume,source=registry_cache,target=/usr/local/cargo/registry \
  cosmwasm/workspace-optimizer:0.14.0
EOF

chmod +x optimize.sh
./optimize.sh

# 验证优化结果
ls -la artifacts/luckee_nft.wasm
```

### 4. 构建验证

```bash
# 检查 WASM 文件大小
wc -c target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm

# 验证 WASM 文件格式
file target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm

# 计算文件哈希
sha256sum target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm
```

## 部署流程

### 1. 使用部署脚本 (推荐)

```bash
# 使用项目提供的部署脚本
./scripts/deploy.sh --admin $ADMIN_ADDRESS --minter $MINTER_ADDRESS

# 或者使用环境变量
ADMIN_ADDRESS=$ADMIN_ADDRESS MINTER_ADDRESS=$MINTER_ADDRESS ./scripts/deploy.sh
```

### 2. 手动部署步骤

#### 2.1 上传合约

```bash
# 上传 WASM 文件到链上
UPLOAD_RESULT=$(wasmd tx wasm store target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --keyring-backend $KEYRING_BACKEND \
  --gas-prices $GAS_PRICES \
  --gas-adjustment $GAS_ADJUSTMENT \
  --gas auto \
  --yes \
  --output json)

# 提取 Code ID
CODE_ID=$(echo "$UPLOAD_RESULT" | jq -r '.logs[0].events[] | select(.type=="store_code") | .attributes[] | select(.key=="code_id") | .value')

echo "Code ID: $CODE_ID"
```

#### 2.2 实例化合约

```bash
# 创建实例化消息
INSTANTIATE_MSG=$(cat <<EOF
{
  "name": "$CONTRACT_NAME",
  "symbol": "LUCKEE",
  "minter": "$MINTER_ADDRESS",
  "base_uri": "$BASE_URI"
}
EOF
)

# 实例化合约
INSTANTIATE_RESULT=$(wasmd tx wasm instantiate $CODE_ID "$INSTANTIATE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --keyring-backend $KEYRING_BACKEND \
  --gas-prices $GAS_PRICES \
  --gas-adjustment $GAS_ADJUSTMENT \
  --gas auto \
  --label "luckee-nft-$CONTRACT_VERSION" \
  --admin $ADMIN_ADDRESS \
  --yes \
  --output json)

# 提取合约地址
CONTRACT_ADDRESS=$(echo "$INSTANTIATE_RESULT" | jq -r '.logs[0].events[] | select(.type=="instantiate") | .attributes[] | select(.key=="_contract_address") | .value')

echo "Contract Address: $CONTRACT_ADDRESS"
```

#### 2.3 配置合约

```bash
# 设置铸造者权限
SET_MINTER_MSG=$(cat <<EOF
{
  "set_minter": {
    "minter": "$MINTER_ADDRESS",
    "allowed": true
  }
}
EOF
)

wasmd tx wasm execute $CONTRACT_ADDRESS "$SET_MINTER_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --keyring-backend $KEYRING_BACKEND \
  --gas-prices $GAS_PRICES \
  --gas-adjustment $GAS_ADJUSTMENT \
  --gas auto \
  --yes \
  --output json
```

### 3. 部署验证

```bash
# 查询合约信息
wasmd query wasm contract $CONTRACT_ADDRESS --node $NODE

# 查询合约配置
CONFIG_QUERY='{"contract_info": {}}'
wasmd query wasm contract-state smart $CONTRACT_ADDRESS "$CONFIG_QUERY" --node $NODE

# 查询合约代码
wasmd query wasm code $CODE_ID --node $NODE
```

### 4. 部署后配置

#### 4.1 设置合成配方

```bash
# 设置基础合成配方
SET_RECIPE_MSG=$(cat <<EOF
{
  "set_recipe": {
    "target": "Firefly",
    "recipe": {
      "inputs": [
        {
          "kind": "Clover",
          "amount": 2
        }
      ],
      "cost": {
        "denom": "uluckee",
        "amount": "1000"
      }
    }
  }
}
EOF
)

wasmd tx wasm execute $CONTRACT_ADDRESS "$SET_RECIPE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --keyring-backend $KEYRING_BACKEND \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --yes
```

#### 4.2 测试铸造功能

```bash
# 测试铸造 NFT
MINT_MSG=$(cat <<EOF
{
  "mint": {
    "token_id": 1,
    "owner": "$ADMIN_ADDRESS",
    "extension": {
      "kind": "Clover",
      "scale_origin": "Tiny",
      "physical_sku": null,
      "crafted_from": null,
      "series_id": "test_001",
      "collection_group_id": null,
      "serial_in_series": 1
    }
  }
}
EOF
)

wasmd tx wasm execute $CONTRACT_ADDRESS "$MINT_MSG" \
  --from $MINTER_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --keyring-backend $KEYRING_BACKEND \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --yes
```

## 回滚操作

### 1. 紧急暂停

```bash
# 暂停合约
PAUSE_MSG='{"pause": {}}'

wasmd tx wasm execute $CONTRACT_ADDRESS "$PAUSE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --keyring-backend $KEYRING_BACKEND \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --yes
```

### 2. 恢复合约

```bash
# 恢复合约
UNPAUSE_MSG='{"unpause": {}}'

wasmd tx wasm execute $CONTRACT_ADDRESS "$UNPAUSE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --keyring-backend $KEYRING_BACKEND \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --yes
```

### 3. 紧急提取资金

```bash
# 紧急提取资金
EMERGENCY_MSG=$(cat <<EOF
{
  "emergency_withdraw": {
    "amount": [
      {
        "denom": "uluckee",
        "amount": "1000000"
      }
    ]
  }
}
EOF
)

wasmd tx wasm execute $CONTRACT_ADDRESS "$EMERGENCY_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --keyring-backend $KEYRING_BACKEND \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --yes
```

## 迁移操作

### 1. 迁移准备

```bash
# 构建新版本合约
cargo build --release --target wasm32-unknown-unknown --no-default-features --features cosmwasm

# 优化新版本
wasm-opt -Os target/wasm32-unknown-unknown/release/luckee_nft.wasm \
  -o target/wasm32-unknown-unknown/release/luckee_nft_v2_optimized.wasm
```

### 2. 上传新版本

```bash
# 上传新版本合约
UPLOAD_RESULT=$(wasmd tx wasm store target/wasm32-unknown-unknown/release/luckee_nft_v2_optimized.wasm \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --keyring-backend $KEYRING_BACKEND \
  --gas-prices $GAS_PRICES \
  --gas-adjustment $GAS_ADJUSTMENT \
  --gas auto \
  --yes \
  --output json)

# 提取新 Code ID
NEW_CODE_ID=$(echo "$UPLOAD_RESULT" | jq -r '.logs[0].events[] | select(.type=="store_code") | .attributes[] | select(.key=="code_id") | .value')

echo "New Code ID: $NEW_CODE_ID"
```

### 3. 执行迁移

```bash
# 执行合约迁移
MIGRATE_MSG='{"migrate": {}}'

wasmd tx wasm migrate $CONTRACT_ADDRESS $NEW_CODE_ID "$MIGRATE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --keyring-backend $KEYRING_BACKEND \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --yes
```

### 4. 迁移验证

```bash
# 验证迁移结果
wasmd query wasm contract $CONTRACT_ADDRESS --node $NODE

# 查询合约代码
wasmd query wasm code $NEW_CODE_ID --node $NODE

# 测试合约功能
CONFIG_QUERY='{"contract_info": {}}'
wasmd query wasm contract-state smart $CONTRACT_ADDRESS "$CONFIG_QUERY" --node $NODE
```

## 安全注意事项

### 1. 密钥安全

- **永远不要**在代码中硬编码私钥
- 使用安全的密钥管理方案
- 定期轮换密钥
- 备份密钥到安全位置

### 2. 部署安全

- 在测试网充分测试后再部署到主网
- 使用多签钱包作为管理员地址
- 设置合理的 Gas 限制
- 监控部署过程

### 3. 运维安全

- 定期备份合约状态
- 监控合约事件和日志
- 设置告警机制
- 建立应急响应流程

### 4. 主网部署特别注意事项

- **必须**使用多签钱包作为管理员
- **必须**在冷钱包中执行关键操作
- **禁止**在 CI/CD 中保存私钥
- **建议**使用硬件钱包

## 故障排除

### 1. 常见问题

#### 1.1 构建失败

```bash
# 清理构建缓存
cargo clean

# 更新依赖
cargo update

# 重新构建
cargo build --release --target wasm32-unknown-unknown
```

#### 1.2 上传失败

```bash
# 检查网络连接
ping rpc.luckee-testnet.com

# 检查账户余额
wasmd query bank balances $ADMIN_ADDRESS --node $NODE

# 增加 Gas 限制
--gas 2000000
```

#### 1.3 实例化失败

```bash
# 检查实例化消息格式
echo "$INSTANTIATE_MSG" | jq .

# 验证地址格式
wasmd keys show $ADMIN_ADDRESS --keyring-backend $KEYRING_BACKEND
```

### 2. 日志分析

```bash
# 查看交易日志
wasmd query tx $TX_HASH --node $NODE

# 查看合约事件
wasmd query wasm contract-state all $CONTRACT_ADDRESS --node $NODE
```

### 3. 性能优化

```bash
# 使用更快的 RPC 节点
export NODE="https://fast-rpc.luckee-testnet.com:443"

# 调整 Gas 价格
export GAS_PRICES="0.05uluckee"

# 使用批量操作
# 在可能的情况下使用 batch_mint 而不是多次 mint
```

## 典型示例命令片段

### 1. 构建 no_std wasm（release + 优化）

```bash
# 基础构建
cargo build --release --target wasm32-unknown-unknown --no-default-features --features cosmwasm

# 优化构建（推荐）
RUSTFLAGS='-C link-arg=-s' cargo build --release --target wasm32-unknown-unknown --no-default-features --features cosmwasm

# 使用 wasm-opt 优化
wasm-opt -Os target/wasm32-unknown-unknown/release/luckee_nft.wasm -o target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm

# 验证构建结果
ls -lh target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm
sha256sum target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm
```

### 2. 简单上传 & instantiate（示例）

```bash
# 设置环境变量
export ADMIN_ADDRESS="luckee1admin..."
export MINTER_ADDRESS="luckee1minter..."
export CHAIN_ID="luckee-testnet"
export NODE="https://rpc.luckee-testnet.com:443"
export GAS_PRICES="0.025uluckee"

# 上传合约
UPLOAD_RESULT=$(wasmd tx wasm store target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --yes \
  --output json)

# 提取 Code ID
CODE_ID=$(echo "$UPLOAD_RESULT" | jq -r '.logs[0].events[] | select(.type=="store_code") | .attributes[] | select(.key=="code_id") | .value')
echo "Code ID: $CODE_ID"

# 实例化合约
INSTANTIATE_MSG='{"name":"Luckee NFT","symbol":"LUCKEE","minter":"'$MINTER_ADDRESS'","base_uri":"https://luckee.io/metadata/"}'

INSTANTIATE_RESULT=$(wasmd tx wasm instantiate $CODE_ID "$INSTANTIATE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --label "luckee-nft-v1" \
  --admin $ADMIN_ADDRESS \
  --yes \
  --output json)

# 提取合约地址
CONTRACT_ADDRESS=$(echo "$INSTANTIATE_RESULT" | jq -r '.logs[0].events[] | select(.type=="instantiate") | .attributes[] | select(.key=="_contract_address") | .value')
echo "Contract Address: $CONTRACT_ADDRESS"
```

### 3. 使用部署脚本（推荐）

```bash
# 基础部署
./scripts/deploy.sh --admin $ADMIN_ADDRESS --minter $MINTER_ADDRESS

# 干运行模式（预览）
./scripts/deploy.sh --admin $ADMIN_ADDRESS --minter $MINTER_ADDRESS --dry-run

# 详细输出模式
./scripts/deploy.sh --admin $ADMIN_ADDRESS --minter $MINTER_ADDRESS --verbose

# 跳过构建步骤
./scripts/deploy.sh --admin $ADMIN_ADDRESS --minter $MINTER_ADDRESS --skip-build

# 生产环境部署
./scripts/deploy_production.sh --admin $ADMIN_ADDRESS --minter $MINTER_ADDRESS
```

### 4. 配置合约权限

```bash
# 设置铸造者权限
SET_MINTER_MSG='{"set_minter":{"minter":"'$MINTER_ADDRESS'","allowed":true}}'

wasmd tx wasm execute $CONTRACT_ADDRESS "$SET_MINTER_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --yes
```

### 5. 设置合成配方

```bash
# 设置基础合成配方
SET_RECIPE_MSG='{
  "set_recipe": {
    "target": "Firefly",
    "recipe": {
      "inputs": [
        {
          "kind": "Clover",
          "amount": 2
        }
      ],
      "cost": {
        "denom": "uluckee",
        "amount": "1000"
      }
    }
  }
}'

wasmd tx wasm execute $CONTRACT_ADDRESS "$SET_RECIPE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --yes
```

### 6. 测试合约功能

```bash
# 测试铸造 NFT
MINT_MSG='{
  "mint": {
    "token_id": 1,
    "owner": "'$ADMIN_ADDRESS'",
    "extension": {
      "kind": "Clover",
      "scale_origin": "Tiny",
      "physical_sku": null,
      "crafted_from": null,
      "series_id": "test_001",
      "collection_group_id": null,
      "serial_in_series": 1
    }
  }
}'

wasmd tx wasm execute $CONTRACT_ADDRESS "$MINT_MSG" \
  --from $MINTER_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas-prices $GAS_PRICES \
  --gas auto \
  --yes

# 查询 NFT 信息
wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"owner_of":{"token_id":1}}' --node $NODE
```

### 7. 验证部署

```bash
# 查询合约信息
wasmd query wasm contract $CONTRACT_ADDRESS --node $NODE

# 查询合约配置
wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"contract_info":{}}' --node $NODE

# 查询所有合成配方
wasmd query wasm contract-state smart $CONTRACT_ADDRESS '{"all_recipes":{}}' --node $NODE

# 查询合约代码
wasmd query wasm code $CODE_ID --node $NODE
```

### 8. 监控和调试

```bash
# 查询最近的合约交易
wasmd query txs --events "wasm._contract_address='$CONTRACT_ADDRESS'" --node $NODE --limit 10

# 查询特定事件
wasmd query txs --events "wasm._contract_address='$CONTRACT_ADDRESS'&wasm.action='mint'" --node $NODE --limit 10

# 查询账户余额
wasmd query bank balances $ADMIN_ADDRESS --node $NODE

# 查询账户信息
wasmd query account $ADMIN_ADDRESS --node $NODE
```

### 9. 错误排查

```bash
# 检查网络连接
ping $(echo $NODE | sed 's|https://||' | sed 's|:443||')

# 检查节点状态
wasmd status --node $NODE

# 检查链ID
wasmd status --node $NODE | jq -r '.node_info.network'

# 检查区块高度
wasmd status --node $NODE | jq -r '.sync_info.latest_block_height'

# 检查交易状态
wasmd query tx $TX_HASH --node $NODE
```

### 10. 一键部署脚本

```bash
#!/bin/bash
# 一键部署脚本示例

set -e

# 配置
ADMIN_ADDRESS="luckee1admin..."
MINTER_ADDRESS="luckee1minter..."
CHAIN_ID="luckee-testnet"
NODE="https://rpc.luckee-testnet.com:443"

echo "🚀 开始一键部署 Luckee NFT 合约..."

# 1. 构建合约
echo "📦 构建合约..."
RUSTFLAGS='-C link-arg=-s' cargo build --release --target wasm32-unknown-unknown --no-default-features --features cosmwasm
wasm-opt -Os target/wasm32-unknown-unknown/release/luckee_nft.wasm -o target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm

# 2. 上传合约
echo "📤 上传合约..."
UPLOAD_RESULT=$(wasmd tx wasm store target/wasm32-unknown-unknown/release/luckee_nft_optimized.wasm \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas auto \
  --yes \
  --output json)

CODE_ID=$(echo "$UPLOAD_RESULT" | jq -r '.logs[0].events[] | select(.type=="store_code") | .attributes[] | select(.key=="code_id") | .value')
echo "✅ Code ID: $CODE_ID"

# 3. 实例化合约
echo "🏗️ 实例化合约..."
INSTANTIATE_MSG='{"name":"Luckee NFT","symbol":"LUCKEE","minter":"'$MINTER_ADDRESS'","base_uri":"https://luckee.io/metadata/"}'

INSTANTIATE_RESULT=$(wasmd tx wasm instantiate $CODE_ID "$INSTANTIATE_MSG" \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas auto \
  --label "luckee-nft-auto" \
  --admin $ADMIN_ADDRESS \
  --yes \
  --output json)

CONTRACT_ADDRESS=$(echo "$INSTANTIATE_RESULT" | jq -r '.logs[0].events[] | select(.type=="instantiate") | .attributes[] | select(.key=="_contract_address") | .value')
echo "✅ Contract Address: $CONTRACT_ADDRESS"

# 4. 配置权限
echo "🔐 配置权限..."
wasmd tx wasm execute $CONTRACT_ADDRESS '{"set_minter":{"minter":"'$MINTER_ADDRESS'","allowed":true}}' \
  --from $ADMIN_ADDRESS \
  --chain-id $CHAIN_ID \
  --node $NODE \
  --gas auto \
  --yes

# 5. 验证部署
echo "✅ 验证部署..."
wasmd query wasm contract $CONTRACT_ADDRESS --node $NODE

echo "🎉 部署完成！"
echo "Code ID: $CODE_ID"
echo "Contract Address: $CONTRACT_ADDRESS"
```

## 部署检查清单

### 部署前检查

- [ ] 环境变量已正确设置
- [ ] 账户余额充足
- [ ] 网络连接正常
- [ ] 依赖软件已安装
- [ ] 密钥已备份

### 构建检查

- [ ] 代码编译通过
- [ ] 测试全部通过
- [ ] WASM 文件已优化
- [ ] 文件大小合理
- [ ] 哈希值已记录

### 部署检查

- [ ] 合约上传成功
- [ ] Code ID 已记录
- [ ] 合约实例化成功
- [ ] 合约地址已记录
- [ ] 权限配置正确

### 部署后检查

- [ ] 合约功能正常
- [ ] 事件记录正确
- [ ] 查询响应正常
- [ ] 错误处理正确
- [ ] 性能表现良好

## 联系支持

如果在部署过程中遇到问题，请：

1. 查看本文档的故障排除部分
2. 检查项目的 GitHub Issues
3. 联系技术支持团队
4. 提供详细的错误日志和环境信息

---

**文档版本**: 1.0.0  
**最后更新**: 2024年12月  
**维护团队**: Luckee DAO
